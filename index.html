<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šå¤©é£Ÿå ‚åƒä»€ä¹ˆï¼Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        :root {
            --bg-color: #f9fafb; /* gray-50 */
            --surface-color: #ffffff;
            --text-color: #18181b; /* zinc-900 */
            --subtext-color: #71717a; /* zinc-500 */
            --border-color: #e4e4e7; /* zinc-200 */
            --input-bg: #ffffff;
            --mood-hover: #fff7ed; /* orange-50 */
        }

        .dark {
            --bg-color: #09090b; /* zinc-950 */
            --surface-color: #18181b; /* zinc-900 */
            --text-color: #f4f4f5; /* zinc-100 */
            --subtext-color: #a1a1aa; /* zinc-400 */
            --border-color: #27272a; /* zinc-800 */
            --input-bg: #09090b;
            --mood-hover: rgba(124, 45, 18, 0.2); /* orange-900/20 */
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Hide scrollbar for textarea but keep functionality */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #71717a;
        }

        /* Mobile specific adjustments */
        @media (max-width: 640px) {
            .mood-btn {
                min-height: 100px;
            }
        }
    </style>
    <!-- Added Toast Styles -->
    <style>
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 50;
            pointer-events: none;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'var(--bg-color)',
                        surface: 'var(--surface-color)',
                        primary: '#f97316',
                        'primary-hover': '#ea580c',
                        border: 'var(--border-color)',
                        subtext: 'var(--subtext-color)',
                        'input-bg': 'var(--input-bg)',
                        'mood-hover': 'var(--mood-hover)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">

    <div class="w-full max-w-2xl mx-auto relative" id="app">
        
        <!-- Decision View (Default Home) -->
        <div id="decisionView" class="fade-in space-y-6 pt-4 sm:pt-0">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showSetup()" class="text-subtext hover:text-primary flex items-center gap-2 transition-colors py-2 font-medium bg-surface px-4 rounded-lg border border-border shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    ç¼–è¾‘èœå•
                </button>
                <span id="menuStatusBadge" class="text-xs text-subtext bg-surface px-3 py-1.5 rounded-full border border-border font-medium shadow-sm flex items-center gap-1">
                    <!-- Content by JS -->
                </span>
            </div>

            <div class="text-center space-y-2 py-8">
                <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</h1>
                <p id="countInfo" class="text-sm text-subtext font-medium">ä»Šæ—¥å‰©ä½™æ¨èæ¬¡æ•°: 3/3</p>
            </div>

            <!-- Mood Selection -->
            <div id="moodSelection" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button onclick="selectMood('spicy')" class="mood-btn group relative overflow-hidden bg-surface hover:bg-mood-hover border border-border hover:border-primary rounded-xl p-4 transition-all duration-300 shadow-sm hover:shadow-md">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ”¥</div>
                    <div class="font-medium text-zinc-600 dark:text-zinc-300 group-hover:text-primary">æƒ³åƒè¾£</div>
                </button>
                <button onclick="selectMood('meat')" class="mood-btn group relative overflow-hidden bg-surface hover:bg-mood-hover border border-border hover:border-primary rounded-xl p-4 transition-all duration-300 shadow-sm hover:shadow-md">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ¥©</div>
                    <div class="font-medium text-zinc-600 dark:text-zinc-300 group-hover:text-primary">è‚‰é£Ÿçˆ±å¥½è€…</div>
                </button>
                <button onclick="selectMood('light')" class="mood-btn group relative overflow-hidden bg-surface hover:bg-mood-hover border border-border hover:border-primary rounded-xl p-4 transition-all duration-300 shadow-sm hover:shadow-md">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ¥—</div>
                    <div class="font-medium text-zinc-600 dark:text-zinc-300 group-hover:text-primary">æ¸…æ·¡/å¥åº·</div>
                </button>
                <button onclick="selectMood('random')" class="mood-btn group relative overflow-hidden bg-surface hover:bg-mood-hover border border-border hover:border-primary rounded-xl p-4 transition-all duration-300 shadow-sm hover:shadow-md">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ²</div>
                    <div class="font-medium text-zinc-600 dark:text-zinc-300 group-hover:text-primary">éšä¾¿</div>
                </button>
            </div>

            <!-- Limit Reached Message -->
            <div id="limitMessage" class="hidden bg-surface border border-border rounded-xl p-8 text-center space-y-3 shadow-xl">
                <div class="text-4xl mb-2">ğŸ›‘</div>
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white">ä»Šæ—¥æ¨èæ¬¡æ•°å·²ç”¨å®Œ</h3>
                <p class="text-subtext">ä¸ºäº†é˜²æ­¢é€‰æ‹©å›°éš¾ç—‡åŠ é‡ï¼Œæ¯å¤©é™åˆ¶æ¨è 3 æ¬¡å“¦</p>
                <button onclick="showSetup()" class="mt-4 text-primary hover:underline text-sm font-medium">
                    æ›´æ–°èœå•å¯é‡ç½®æ¬¡æ•°
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingCard" class="hidden bg-surface border border-border rounded-xl p-12 text-center shadow-xl">
                <div class="inline-block w-10 h-10 border-4 border-border border-t-primary rounded-full animate-spin mb-4"></div>
                <p id="loadingText" class="text-subtext animate-pulse font-medium">AI æ­£åœ¨æ€è€ƒä¸­...</p>
            </div>

            <!-- Result Card -->
            <div id="recommendationCard" class="hidden scale-in bg-surface border border-border rounded-xl overflow-hidden shadow-2xl transition-colors duration-300">
                <div class="p-8 text-center border-b border-border bg-gradient-to-b from-transparent to-zinc-50/50 dark:to-zinc-900/50">
                    <div id="dishEmoji" class="text-6xl mb-4 animate-bounce">ğŸ½ï¸</div>
                    <h2 id="dishName" class="text-3xl font-bold text-primary mb-3"></h2>
                    
                    <!-- Added History Warning Badge -->
                    <div id="historyWarning" class="hidden mb-2">
                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">âš ï¸ å†å²èœå“è€—å°½ï¼Œéšæœºæ¨è</span>
                    </div>

                    <!-- Unselected Moods for Quick Switch -->
                     <div class="flex flex-col items-center justify-center gap-3 mt-6 pt-4 border-t border-border/50">
                        <p class="text-xs text-subtext font-medium">ä¸å¤ªæ»¡æ„ï¼Ÿè¯•è¯•å…¶ä»–å£å‘³ï¼š</p>
                        <div id="alternativeMoods" class="flex flex-wrap justify-center gap-2">
                            <!-- Chips injected by JS -->
                        </div>
                    </div>
                </div>
                
                <div id="aiContent" class="p-6 space-y-6 bg-zinc-50 dark:bg-zinc-900/50">
                    <div class="space-y-2">
                        <h4 class="text-xs font-bold text-subtext uppercase tracking-wider">æ¨èç†ç”±</h4>
                        <p id="reasonText" class="text-zinc-700 dark:text-zinc-300 leading-relaxed"></p>
                    </div>
                    
                    <div class="pt-4 border-t border-border">
                        <p id="encouragementText" class="text-orange-500 dark:text-orange-400 italic font-medium text-center flex items-center justify-center gap-2">
                            <!-- Content injected by JS -->
                        </p>
                    </div>
                </div>

                <div class="p-4 bg-surface border-t border-border flex flex-col gap-3">
                    <!-- Added Confirm Button and rearranged buttons -->
                    <button onclick="confirmChoice()" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-orange-900/20 flex items-center justify-center gap-2">
                        <span>ğŸ˜‹</span> å†³å®šåƒè¿™ä¸ª
                    </button>

                    <button onclick="regenerate()" id="regenerateBtn" class="w-full bg-transparent hover:bg-mood-hover text-zinc-600 dark:text-zinc-300 hover:text-primary border border-border hover:border-primary font-semibold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                        <span id="regenerateBtnText">æ¢ä¸€ä¸ªæ¨è</span>
                    </button>
                </div>
            </div>

            <!-- Added GitHub Footer to Decision View -->
            <div class="mt-8 pb-4 text-center">
                <a href="https://github.com/qingkong-template/AI-Meal" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs text-subtext hover:text-primary transition-colors opacity-60 hover:opacity-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                    GitHub å¼€æºé¡¹ç›®
                </a>
            </div>
        </div>

        <!-- Setup View (Edit Menu) -->
        <div id="setupView" class="hidden fade-in space-y-6 pt-10 sm:pt-0 relative">
            <!-- Header Controls (Only visible in Setup) -->
            <div class="absolute top-0 right-0 z-10 flex items-center gap-2">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 text-subtext hover:text-primary bg-surface border border-border hover:border-primary rounded-full transition-all shadow-sm" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg id="iconSun" class="hidden w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="iconMoon" class="hidden w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <!-- Settings Button -->
                <button onclick="showSettings()" class="p-2 text-subtext hover:text-primary bg-surface border border-border hover:border-primary rounded-full transition-all shadow-sm" title="è®¾ç½®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <!-- Added tab navigation -->
            <div class="text-center space-y-4">
                <h1 class="text-3xl font-bold tracking-tight text-zinc-900 dark:text-white">ç¼–è¾‘èœå•</h1>
                
                <!-- Tab Navigation -->
                <div class="flex justify-center gap-2 border-b border-border">
                    <button 
                        id="tabEditMenu" 
                        onclick="switchTab('editMenu')" 
                        class="px-6 py-3 font-medium transition-colors border-b-2 border-primary text-primary">
                        ç¼–è¾‘èœå•
                    </button>
                    <button 
                        id="tabHistory" 
                        onclick="switchTab('history')" 
                        class="px-6 py-3 font-medium transition-colors border-b-2 border-transparent text-subtext hover:text-primary">
                        ç”¨é¤å†å²
                    </button>
                </div>
                
                <!-- AI Status Badge (Only show in edit menu tab) -->
                <div id="aiStatusContainer" class="flex justify-center transition-opacity duration-300">
                    <button onclick="toggleAIFromBadge()" id="aiStatusBadge" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium border transition-colors duration-300 cursor-pointer hover:opacity-80 shadow-sm">
                        <span id="aiStatusIcon">âœ•</span>
                        <span id="aiStatusText">AI æ™ºèƒ½æ¨èæœªå¯ç”¨</span>
                    </button>
                </div>
            </div>

            <!-- Edit Menu Tab Content -->
            <div id="editMenuContent" class="space-y-4">
                <p class="text-subtext text-center">è¾“å…¥ä½ å¸¸å»çš„é¤å…æˆ–é£Ÿå ‚èœå•</p>
                
                <div class="bg-surface border border-border rounded-xl p-4 sm:p-6 shadow-xl transition-colors duration-300">
                    <textarea 
                        id="menuInput" 
                        class="w-full h-64 bg-input-bg border border-border rounded-lg p-4 text-zinc-900 dark:text-white placeholder-zinc-400 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all resize-none mb-4 font-sans text-base leading-relaxed"
                        placeholder="åœ¨æ­¤ç²˜è´´èœå•... (æ”¯æŒè‡ªåŠ¨è¯†åˆ«)&#10;&#10;ç¤ºä¾‹:&#10;çº¢çƒ§ç‰›è‚‰é¢ å®«ä¿é¸¡ä¸&#10;æ¸…ç‚’æ—¶è”¬ æ°´ç…®é±¼&#10;éº»è¾£é¦™é”…"
                    ></textarea>
                    
                    <button onclick="parseMenu()" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-3 px-6 rounded-lg transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg shadow-orange-900/20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        ä¿å­˜å¹¶å»é€‰æ‹©
                    </button>
                </div>
            </div>

            <!-- Meal History Tab Content -->
            <div id="historyContent" class="hidden space-y-4">
                <p class="text-subtext text-center">æŸ¥çœ‹å’Œç®¡ç†ä½ çš„ç”¨é¤è®°å½•</p>
                
                <div class="bg-surface border border-border rounded-xl p-4 sm:p-6 shadow-xl transition-colors duration-300">
                    <div id="historyList" class="space-y-3">
                        <!-- History items will be rendered here by JS -->
                    </div>
                    
                    <div id="emptyHistory" class="hidden text-center py-12 text-subtext">
                        <div class="text-4xl mb-3">ğŸ“‹</div>
                        <p>è¿˜æ²¡æœ‰ç”¨é¤è®°å½•</p>
                        <p class="text-sm mt-2">ç‚¹å‡»"å†³å®šåƒè¿™ä¸ª"åä¼šè‡ªåŠ¨è®°å½•</p>
                    </div>
                </div>
                
                <button onclick="showDecision()" class="w-full bg-transparent hover:bg-mood-hover text-zinc-600 dark:text-zinc-300 hover:text-primary border border-border hover:border-primary font-semibold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    è¿”å›æ¨è
                </button>
            </div>

            <!-- Added GitHub Footer to Setup View -->
            <div class="mt-8 pb-4 text-center">
                <a href="https://github.com/qingkong-template/AI-Meal" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs text-subtext hover:text-primary transition-colors opacity-60 hover:opacity-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                    GitHub å¼€æºé¡¹ç›®
                </a>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="hidden fade-in space-y-6 pt-10 sm:pt-0">
            <div class="flex items-center justify-between mb-2">
                <button onclick="cancelSettings()" class="text-subtext hover:text-primary flex items-center gap-2 transition-colors py-2 font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    è¿”å›
                </button>
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white">è®¾ç½®</h2>
                <div class="w-10"></div> 
            </div>

            <div class="bg-surface border border-border rounded-xl p-6 space-y-6 shadow-xl transition-colors duration-300">
                <div class="space-y-4">
                    <!-- API Key Section -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-zinc-900 dark:text-white">OpenRouter API Key</label>
                        <input 
                            type="text" 
                            id="apiKeyInput" 
                            class="w-full bg-input-bg border border-border rounded-lg px-4 py-3 text-zinc-900 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all font-mono text-sm"
                            placeholder="sk-or-v1-..."
                        >
                        
                        <!-- Key Actions & Info -->
                        <div class="flex flex-col gap-2 mt-2">
                             <p class="text-xs text-subtext">
                                é…ç½® API Key ä»¥å¯ç”¨ AI æ™ºèƒ½æ¨èã€‚
                                <a href="https://openrouter.ai" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline ml-1">è·å– Key</a>
                            </p>
                            
                            <!-- Example Key Box -->
                            <div class="bg-gray-100 dark:bg-zinc-800/50 border border-border rounded p-3 text-xs break-all">
                                <span class="text-subtext block mb-1 font-medium">æµ‹è¯•ç”¨ Key (ç‚¹å‡»å¤åˆ¶):</span>
                                <code 
                                    class="text-zinc-600 dark:text-zinc-400 font-mono cursor-pointer hover:text-primary transition-colors select-all"
                                    onclick="copyTestKey(this)"
                                    title="ç‚¹å‡»å¤åˆ¶"
                                >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</code>
                            </div>
                        </div>
                    </div>

                    <!-- Added Avoid Days Setting -->
                    <div class="space-y-2 pt-4 border-t border-border">
                        <label class="block text-sm font-medium text-zinc-900 dark:text-white">é‡å¤èœå“é¿è®©å¤©æ•°</label>
                        <div class="flex items-center gap-4">
                            <input 
                                type="number" 
                                id="avoidDaysInput" 
                                min="0" 
                                max="30"
                                class="w-24 bg-input-bg border border-border rounded-lg px-4 py-2 text-zinc-900 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary text-center font-medium"
                                value="7"
                            >
                            <span class="text-subtext text-sm">å¤©å†…ä¸å†æ¨èå·²ç¡®è®¤çš„èœå“</span>
                        </div>
                        <p class="text-xs text-subtext">è®¾ç½®ä¸º 0 åˆ™ä¸å¼€å¯é¿è®©åŠŸèƒ½</p>
                    </div>

                    <!-- Added Avoid Days Setting for Recommended but Unconfirmed Dishes -->
                    <div class="space-y-2 pt-4 border-t border-border">
                        <label class="block text-sm font-medium text-zinc-900 dark:text-white">æ¨èè¿‡çš„èœå“é¿è®©å¤©æ•°</label>
                        <div class="flex items-center gap-4">
                            <input 
                                type="number" 
                                id="recommendedAvoidDaysInput" 
                                min="0" 
                                max="30"
                                class="w-24 bg-input-bg border border-border rounded-lg px-4 py-2 text-zinc-900 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary text-center font-medium"
                                value="0"
                            >
                            <span class="text-subtext text-sm">å¤©å†…ä¸å†æ¨èå‡ºç°è¿‡çš„èœå“</span>
                        </div>
                        <p class="text-xs text-subtext">é»˜è®¤ä¸º 0ï¼ˆä¸è¿‡æ»¤æ¨èè¿‡çš„èœå“ï¼‰ï¼Œè®¾ç½®å¤©æ•°åå¼€å§‹è¿‡æ»¤</p>
                    </div>

                    <div class="pt-4 border-t border-border">
                        <h3 class="text-sm font-medium text-zinc-900 dark:text-white mb-3">åŠŸèƒ½è¯´æ˜</h3>
                        <ul class="space-y-2 text-sm text-subtext">
                            <li class="flex items-start gap-2">
                                <span class="text-primary mt-1">â€¢</span>
                                <span>AI ä¼šæ ¹æ®ä½ çš„å¿ƒæƒ…å’Œèœå•å†…å®¹ï¼Œæ™ºèƒ½æ¨èæœ€åˆé€‚çš„èœå“</span>
                            </li>
                             <li class="flex items-start gap-2">
                                <span class="text-primary mt-1">â€¢</span>
                                <span>å¦‚æœæœªè¾“å…¥èœå•ä½†é…ç½®äº†Keyï¼ŒAIå°†æ¨èé€šç”¨å·¥ä½œé¤</span>
                            </li>
                            <!-- Added history explanation -->
                             <li class="flex items-start gap-2">
                                <span class="text-primary mt-1">â€¢</span>
                                <span>ç‚¹å‡»"å†³å®šåƒè¿™ä¸ª"ä¼šè®°å½•å†å²ï¼Œé¿å…è¿‘æœŸé‡å¤æ¨è</span>
                            </li>
                        </ul>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-orange-900/20">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Added Toast Element -->
        <div id="toast" class="toast">å·²åŠ å…¥ç”¨é¤å†å²ï¼Œä¸‹æ¬¡ä¸ºæ‚¨é¿å¼€è¯¥èœå“ âœ…</div>

    </div>

    <script>
        // Configuration
        const MODEL_NAME = 'tngtech/deepseek-r1t2-chimera:free';
        const MAX_RECOMMENDATIONS = 3;
        const MOODS = {
            'spicy': { text: 'æƒ³åƒè¾£', icon: 'ğŸ”¥' },
            'meat': { text: 'è‚‰é£Ÿçˆ±å¥½è€…', icon: 'ğŸ¥©' },
            'light': { text: 'æ¸…æ·¡/å¥åº·', icon: 'ğŸ¥—' },
            'random': { text: 'éšä¾¿', icon: 'ğŸ²' }
        };

        // State
        let state = {
            view: 'decision',
            menuItems: [],
            apiKey: '',
            aiEnabled: false,
            recommendationCount: 0,
            lastMood: '',
            history: [], // { dish: string, timestamp: number }
            avoidDays: 7,
            recommendedHistory: [], // { dish: string, timestamp: number }
            recommendedAvoidDays: 0
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadState();
            
            const textarea = document.getElementById('menuInput');
            textarea.addEventListener('input', function() {
                localStorage.setItem('dinner-menu-text', this.value);
                parseMenuLines(this.value); // Update state quietly
            });
            
            // Initial Parse to set menuItems
            if(textarea.value) parseMenuLines(textarea.value);
            
            // Force show decision view on load, unless specific condition met
            showDecision();
            
            // Initial Tab Setup (ensure editMenu is shown by default)
            switchTab('editMenu'); 
        });

        // Theme Logic
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            const sun = document.getElementById('iconSun');
            const moon = document.getElementById('iconMoon');
            
            if (isDark) {
                sun.classList.remove('hidden');
                moon.classList.add('hidden');
            } else {
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            }
        }

        function loadState() {
            // Load Menu
            const savedMenu = localStorage.getItem('dinner-menu-text');
            if (savedMenu) {
                document.getElementById('menuInput').value = savedMenu;
            }

            // Load API Key
            const savedApiKey = localStorage.getItem('openrouter-api-key');
            
            if (savedApiKey && savedApiKey.trim() !== '') {
                state.apiKey = savedApiKey;
                state.aiEnabled = true;
                document.getElementById('apiKeyInput').value = savedApiKey;
            } else {
                state.apiKey = '';
                state.aiEnabled = false;
                document.getElementById('apiKeyInput').value = '';
            }

            // Load Count
            const savedCount = localStorage.getItem('recommendation-count');
            if (savedCount) {
                state.recommendationCount = parseInt(savedCount, 10);
            }

            const savedHistory = localStorage.getItem('dinner-history');
            if (savedHistory) {
                state.history = JSON.parse(savedHistory);
            }

            const savedAvoidDays = localStorage.getItem('avoid-days');
            if (savedAvoidDays !== null) {
                state.avoidDays = parseInt(savedAvoidDays, 10);
            }
            document.getElementById('avoidDaysInput').value = state.avoidDays;

            const savedRecommendedHistory = localStorage.getItem('recommended-history');
            if (savedRecommendedHistory) {
                state.recommendedHistory = JSON.parse(savedRecommendedHistory);
            }

            const savedRecommendedAvoidDays = localStorage.getItem('recommended-avoid-days');
            if (savedRecommendedAvoidDays !== null) {
                state.recommendedAvoidDays = parseInt(savedRecommendedAvoidDays, 10);
            }
            document.getElementById('recommendedAvoidDaysInput').value = state.recommendedAvoidDays;

            updateAIStatusUI();
        }

        function updateAIStatusUI() {
            const badge = document.getElementById('aiStatusBadge');
            const icon = document.getElementById('aiStatusIcon');
            const text = document.getElementById('aiStatusText');
            
            const menuBadge = document.getElementById('menuStatusBadge');

            if (state.aiEnabled) {
                badge.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium border transition-colors duration-300 border-green-800 bg-green-900/10 dark:bg-green-900/30 text-green-600 dark:text-green-400 cursor-pointer hover:opacity-80";
                icon.textContent = "âœ“";
                text.textContent = "AI æ™ºèƒ½æ¨èå·²å¯ç”¨";
            } else {
                badge.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium border transition-colors duration-300 border-zinc-200 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800/50 text-zinc-500 cursor-pointer hover:opacity-80";
                icon.textContent = "âœ•";
                text.textContent = "AI æ™ºèƒ½æ¨èæœªå¯ç”¨";
            }
        }

        function toggleAIFromBadge() {
            if (state.aiEnabled) {
                showSettings();
            } else {
                if (state.apiKey && state.apiKey.trim() !== '') {
                    state.aiEnabled = true;
                    updateAIStatusUI();
                } else {
                    if (confirm("è¯·å…ˆé…ç½® API Key æ‰èƒ½å¯ç”¨æ™ºèƒ½æ¨èã€‚æ˜¯å¦å‰å¾€è®¾ç½®ï¼Ÿ")) {
                        showSettings();
                    }
                }
            }
        }

        function copyTestKey(el) {
            const key = el.innerText;
            navigator.clipboard.writeText(key).then(() => {
                const originalBg = el.parentElement.className;
                el.parentElement.classList.add('bg-green-100', 'dark:bg-green-900/30');
                setTimeout(() => {
                    el.parentElement.className = originalBg;
                }, 500);
            });
            
            const input = document.getElementById('apiKeyInput');
            if (!input.value) {
                input.value = key;
            }
        }

        function saveSettings() {
            const inputKey = document.getElementById('apiKeyInput').value.trim();
            
            const days = parseInt(document.getElementById('avoidDaysInput').value, 10);
            state.avoidDays = isNaN(days) ? 7 : days;
            localStorage.setItem('avoid-days', state.avoidDays);
            
            const recDays = parseInt(document.getElementById('recommendedAvoidDaysInput').value, 10);
            state.recommendedAvoidDays = isNaN(recDays) ? 0 : recDays;
            localStorage.setItem('recommended-avoid-days', state.recommendedAvoidDays);
            
            if (inputKey) {
                localStorage.setItem('openrouter-api-key', inputKey);
                state.apiKey = inputKey;
                state.aiEnabled = true;
            } else {
                localStorage.setItem('openrouter-api-key', '');
                state.apiKey = '';
                state.aiEnabled = false;
            }

            updateAIStatusUI();
            showSetup();
        }

        function cancelSettings() {
            const currentKey = state.apiKey || '';
            document.getElementById('apiKeyInput').value = currentKey;
            document.getElementById('avoidDaysInput').value = state.avoidDays;
            document.getElementById('recommendedAvoidDaysInput').value = state.recommendedAvoidDays;
            showSetup();
        }

        // Navigation
        function showSetup() {
            switchView('setupView');
        }

        function showSettings() {
            const displayKey = state.apiKey || '';
            document.getElementById('apiKeyInput').value = displayKey;
            showView('settingsView'); // Changed from switchView to showView for clarity
        }

        function showDecision() {
            // Check status for badge
            const badge = document.getElementById('menuStatusBadge');
            if (state.menuItems.length > 0) {
                badge.innerHTML = `<span>ğŸ“</span> å·²åŠ è½½ ${state.menuItems.length} é“èœ`;
                badge.classList.remove('hidden');
            } else if (state.aiEnabled) {
                badge.innerHTML = `<span>ğŸ¤–</span> AI é€šç”¨æ¨èæ¨¡å¼`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            showView('decisionView'); // Changed from switchView
            updateCountDisplay();
            checkRecommendationLimit();
        }

        function switchView(viewId) { // Kept for backward compatibility/internal use if needed
            ['setupView', 'settingsView', 'decisionView'].forEach(id => {
                const el = document.getElementById(id);
                if (id === viewId) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function showView(viewId) { // New explicit show function
             document.getElementById('decisionView').classList.add('hidden');
             document.getElementById('setupView').classList.add('hidden');
             document.getElementById('settingsView').classList.add('hidden');
             document.getElementById(viewId).classList.remove('hidden');
        }

        // Core Logic
        function parseMenuLines(text) {
            const rawLines = text.split('\n');
            let items = [];
            rawLines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                parts.forEach(part => {
                    if (part && part.length > 0) {
                        items.push(part);
                    }
                });
            });
            state.menuItems = items;
        }

        function parseMenu() {
            const text = document.getElementById('menuInput').value;
            parseMenuLines(text);
            
            // Reset count when updating menu
            state.recommendationCount = 0;
            localStorage.setItem('recommendation-count', '0');
            
            showDecision();
        }

        function checkRecommendationLimit() {
            const limitEl = document.getElementById('limitMessage');
            const optionsEl = document.getElementById('moodSelection');
            const resultEl = document.getElementById('recommendationCard');
            
            if (state.recommendationCount >= MAX_RECOMMENDATIONS) {
                limitEl.classList.remove('hidden');
                optionsEl.classList.add('hidden');
                resultEl.classList.add('hidden');
            } else {
                limitEl.classList.add('hidden');
                if (resultEl.classList.contains('hidden')) {
                    optionsEl.classList.remove('hidden');
                }
            }
        }

        function updateCountDisplay() {
            const remaining = Math.max(0, MAX_RECOMMENDATIONS - state.recommendationCount);
            document.getElementById('countInfo').textContent = `ä»Šæ—¥å‰©ä½™æ¨èæ¬¡æ•°: ${remaining}/${MAX_RECOMMENDATIONS}`;
        }

        function selectMood(mood) {
            if (state.recommendationCount >= MAX_RECOMMENDATIONS) return;
            
            // Rule Check
            // 1. No Menu + No AI -> Alert
            if (state.menuItems.length === 0 && !state.aiEnabled) {
                if(confirm("ä½ è¿˜æ²¡æœ‰è¾“å…¥èœå•ï¼Œä¹Ÿæ²¡æœ‰é…ç½® AI Keyã€‚\n\nè¯·å…ˆå»ã€ç¼–è¾‘èœå•ã€‘è¾“å…¥ä»Šæ—¥èœè°±ï¼Œæˆ–è€…é…ç½® Key è®© AI è‡ªç”±æ¨èã€‚")) {
                    showSetup();
                }
                return;
            }

            state.lastMood = mood;
            getRecommendation(mood);
        }

        function regenerate() {
            if (state.recommendationCount >= MAX_RECOMMENDATIONS) return;
            getRecommendation(state.lastMood);
        }

        function getRecentHistoryDishes() {
            if (state.avoidDays <= 0) return [];
            
            const cutoff = Date.now() - (state.avoidDays * 24 * 60 * 60 * 1000);
            return state.history
                .filter(item => item.timestamp > cutoff)
                .map(item => item.dish);
        }

        function getRecentRecommendedDishes() {
            if (state.recommendedAvoidDays <= 0) return [];
            
            const cutoff = Date.now() - (state.recommendedAvoidDays * 24 * 60 * 60 * 1000);
            return state.recommendedHistory
                .filter(item => item.timestamp > cutoff)
                .map(item => item.dish);
        }

        async function getRecommendation(mood) {
            document.getElementById('moodSelection').classList.add('hidden');
            document.getElementById('recommendationCard').classList.add('hidden');
            document.getElementById('loadingCard').classList.remove('hidden');
            document.getElementById('historyWarning').classList.add('hidden');
            
            document.getElementById('loadingText').textContent = state.aiEnabled ? "AI æ­£åœ¨æ€è€ƒä¸­..." : "æ™ºèƒ½æ¨èä¸­...";

            try {
                let result;
                
                const recentHistory = getRecentHistoryDishes();
                const recentRecommended = getRecentRecommendedDishes();
                
                if (state.aiEnabled && state.apiKey) {
                     if (state.menuItems.length === 0) {
                        result = await getAIGenericRecommendation(mood, recentHistory, recentRecommended);
                     } 
                     else {
                        result = await getAIRecommendation(mood, recentHistory, recentRecommended);
                     }
                } 
                else {
                    result = await getLocalRecommendation(mood, recentHistory, recentRecommended);
                }

                state.recommendedHistory.push({
                    dish: result.dish,
                    timestamp: Date.now()
                });
                localStorage.setItem('recommended-history', JSON.stringify(state.recommendedHistory));

                showResult(result, mood);
                
                state.recommendationCount++;
                localStorage.setItem('recommendation-count', state.recommendationCount.toString());
                updateCountDisplay();

            } catch (error) {
                console.error('Error:', error);
                alert('æ¨èå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚');
                document.getElementById('moodSelection').classList.remove('hidden');
                document.getElementById('loadingCard').classList.add('hidden');
            }
        }

        async function getAIRecommendation(mood, recentHistory, recentRecommended) {
            const moodConfig = MOODS[mood] || MOODS['random'];
            
            const allAvoid = [...recentHistory, ...recentRecommended];
            const historyText = allAvoid.length > 0 
                ? `è¯·é¿å¼€ä»¥ä¸‹æœ€è¿‘åƒè¿‡æˆ–æ¨èè¿‡çš„èœå“ï¼š${allAvoid.join(', ')}ã€‚` 
                : "";

            const prompt = `
                èœå•ï¼š${JSON.stringify(state.menuItems)}
                ç”¨æˆ·å¿ƒæƒ…ï¼š${moodConfig.text}
                ${historyText}
                
                è¯·ä»èœå•ä¸­é€‰æ‹©ä¸€é“æœ€é€‚åˆçš„èœã€‚
                è¿”å› JSON æ ¼å¼ï¼š
                {
                    "dish": "èœå",
                    "reason": "20å­—ä»¥å†…çš„æ¨èç†ç”±ï¼Œå¹½é»˜æœ‰è¶£",
                    "quote": "ä¸€å¥å……æ»¡æ­£èƒ½é‡çš„æ¯æ—¥é¼“åŠ±ï¼Œå¸¦emoji"
                }
            `;
            return callAI(prompt);
        }

        async function getAIGenericRecommendation(mood, recentHistory, recentRecommended) {
            const moodConfig = MOODS[mood] || MOODS['random'];
            
            const allAvoid = [...recentHistory, ...recentRecommended];
            const historyText = allAvoid.length > 0 
                ? `è¯·é¿å¼€ä»¥ä¸‹æœ€è¿‘åƒè¿‡æˆ–æ¨èè¿‡çš„èœå“ï¼š${allAvoid.join(', ')}ã€‚` 
                : "";

            const prompt = `
                åœºæ™¯ï¼šä¸­å›½å…¬å¸å‘˜å·¥çš„å·¥ä½œé¤ã€‚
                ç›®å‰æ²¡æœ‰å…·ä½“èœå•ã€‚
                ç”¨æˆ·å¿ƒæƒ…ï¼š${moodConfig.text}
                ${historyText}
                
                è¯·æ¨èä¸€é“å¸¸è§çš„ã€é€‚åˆä¸­å›½èŒåœºäººçš„${moodConfig.text}å·¥ä½œåˆé¤ï¼ˆä¾‹å¦‚ï¼šé±¼é¦™è‚‰ä¸ç›–é¥­ã€éº»è¾£çƒ«ã€æ²™å¿å°åƒç­‰ï¼‰ã€‚
                è¿”å› JSON æ ¼å¼ï¼š
                {
                    "dish": "é€šç”¨èœå",
                    "reason": "20å­—ä»¥å†…çš„æ¨èç†ç”±ï¼Œç»“åˆæ‰“å·¥äººè¯­å¢ƒ",
                    "quote": "ä¸€å¥å……æ»¡æ­£èƒ½é‡çš„æ¯æ—¥é¼“åŠ±ï¼Œå¸¦emoji"
                }
            `;
            return callAI(prompt);
        }

        async function callAI(prompt) {
             const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${state.apiKey}`,
                    "HTTP-Referer": window.location.href,
                    "X-Title": "Dinner Assistant"
                },
                body: JSON.stringify({
                    "model": MODEL_NAME,
                    "messages": [
                        { "role": "user", "content": prompt }
                    ]
                })
            });

            if (!response.ok) throw new Error('API Request failed');

            const data = await response.json();
            let content = data.choices[0].message.content;
            // Clean markdown code blocks if present
            if (content.includes('\`\`\`json')) {
                content = content.split('\`\`\`json')[1].split('\`\`\`')[0];
            } else if (content.includes('\`\`\`')) {
                content = content.split('\`\`\`')[1].split('\`\`\`')[0];
            }
            
            return JSON.parse(content.trim());
        }

        function getLocalRecommendation(mood, recentHistory, recentRecommended) {
            return new Promise(resolve => {
                setTimeout(() => {
                    let candidates = state.menuItems;
                    
                    // Filter out both recent history and recent recommended
                    const allAvoid = [...recentHistory, ...recentRecommended];
                    if (allAvoid.length > 0) {
                        const filtered = candidates.filter(dish => !allAvoid.includes(dish));
                        if (filtered.length > 0) {
                            candidates = filtered;
                        } else {
                            document.getElementById('historyWarning').classList.remove('hidden');
                        }
                    }

                    const dish = candidates[Math.floor(Math.random() * candidates.length)];
                    const reasons = [
                        "è¿™é“èœçœ‹èµ·æ¥å°±å¾ˆä¸‹é¥­ï¼",
                        "ç›¸ä¿¡ç›´è§‰ï¼Œå°±å®ƒäº†ï¼",
                        "ä»Šå¤©åƒç‚¹ä¸ä¸€æ ·çš„ï¼",
                        "è¥å…»å‡è¡¡ï¼Œç¾å‘³å¥åº·ï¼",
                        "å¬è¯´è¿™é“èœå£ç¢‘ä¸é”™å“¦ï¼"
                    ];
                    const quotes = [
                        "ğŸŒŸ åˆæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼",
                        "ğŸ’ª åƒé¥±äº†æ‰æœ‰åŠ›æ°”å¹²æ´»ï¼",
                        "ğŸŒˆ ç”Ÿæ´»æ˜æœ—ï¼Œä¸‡ç‰©å¯çˆ±ï¼",
                        "âœ¨ å³ä½¿æ˜¯å°äº‹ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ï¼",
                        "ğŸ€ æ‰€æœ‰çš„å¥½è¿æ­£åœ¨å‘ä½ å¥”èµ´ï¼"
                    ];

                    resolve({
                        dish: dish,
                        reason: reasons[Math.floor(Math.random() * reasons.length)],
                        quote: quotes[Math.floor(Math.random() * quotes.length)]
                    });
                }, 800);
            });
        }

        function showResult(result, currentMood) {
            document.getElementById('loadingCard').classList.add('hidden');
            const card = document.getElementById('recommendationCard');
            card.classList.remove('hidden');

            document.getElementById('dishName').textContent = result.dish;
            document.getElementById('reasonText').textContent = result.reason;
            document.getElementById('encouragementText').innerHTML = `<span>âœ¨</span> ${result.quote}`;
            
            document.getElementById('recommendationCard').dataset.currentDish = result.dish;

            // Generate Alternative Chips
            const chipsContainer = document.getElementById('alternativeMoods');
            chipsContainer.innerHTML = '';
            
            Object.entries(MOODS).forEach(([key, config]) => {
                if (key !== currentMood) {
                    const chip = document.createElement('button');
                    chip.className = "px-3 py-1.5 rounded-full text-xs font-medium bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 hover:bg-primary hover:text-white transition-colors border border-transparent hover:border-primary flex items-center gap-1";
                    chip.innerHTML = `<span>${config.icon}</span> ${config.text}`;
                    chip.onclick = () => selectMood(key);
                    chipsContainer.appendChild(chip);
                }
            });

            const btn = document.getElementById('regenerateBtn');
            const btnText = document.getElementById('regenerateBtnText');
            
            if (state.recommendationCount + 1 > MAX_RECOMMENDATIONS) { // Check if next click would exceed limit
                 // This means the current recommendation is the last one allowed.
                 // The regenerate button should reflect that no more are available.
                 // The limit message handles hiding mood selection.
            }

            if (state.recommendationCount >= MAX_RECOMMENDATIONS) {
                 btnText.textContent = "ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ";
                 // The limit message will be shown, but the card might still be visible.
                 // The logic in regenerate() prevents further calls anyway.
            } else {
                 btnText.textContent = "å†æ¨èä¸€ä¸ª";
            }
        }
        
        function confirmChoice() {
            const card = document.getElementById('recommendationCard');
            const dish = card.dataset.currentDish;
            
            if (!dish) return;
            
            // Add to history
            state.history.push({
                dish: dish,
                timestamp: Date.now()
            });
            
            // Save to local storage
            localStorage.setItem('dinner-history', JSON.stringify(state.history));
            
            // Show toast
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
            
            // Reset view after delay
            setTimeout(() => {
                // Resetting the card and showing mood selection again makes sense
                // as the user has "decided" and the cycle can continue if limits allow.
                card.classList.add('hidden');
                document.getElementById('moodSelection').classList.remove('hidden');
                
                // Optionally, clear the current dish from the card data.
                card.dataset.currentDish = '';

            }, 1500);
        }

        function switchTab(tab) {
            const editMenuTab = document.getElementById('tabEditMenu');
            const historyTab = document.getElementById('tabHistory');
            const editMenuContent = document.getElementById('editMenuContent');
            const historyContent = document.getElementById('historyContent');
            const aiStatusContainer = document.getElementById('aiStatusContainer');
            
            if (tab === 'editMenu') {
                editMenuTab.className = "px-6 py-3 font-medium transition-colors border-b-2 border-primary text-primary";
                historyTab.className = "px-6 py-3 font-medium transition-colors border-b-2 border-transparent text-subtext hover:text-primary";
                editMenuContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                aiStatusContainer.classList.remove('hidden');
            } else {
                editMenuTab.className = "px-6 py-3 font-medium transition-colors border-b-2 border-transparent text-subtext hover:text-primary";
                historyTab.className = "px-6 py-3 font-medium transition-colors border-b-2 border-primary text-primary";
                editMenuContent.classList.add('hidden');
                historyContent.classList.remove('hidden');
                aiStatusContainer.classList.add('hidden');
                renderHistory();
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            
            // Sort by most recent first
            const sortedHistory = [...state.history].sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedHistory.length === 0) {
                historyList.innerHTML = '';
                historyList.classList.add('hidden');
                emptyHistory.classList.remove('hidden');
                return;
            }
            
            historyList.classList.remove('hidden');
            emptyHistory.classList.add('hidden');
            
            historyList.innerHTML = sortedHistory.map((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                return `
                    <div class="flex items-center justify-between p-4 bg-input-bg border border-border rounded-lg hover:border-primary transition-colors">
                        <div class="flex-1">
                            <div class="font-medium text-zinc-900 dark:text-white">${item.dish}</div>
                            <div class="text-xs text-subtext mt-1">${dateStr}</div>
                        </div>
                        <button 
                            onclick="removeHistoryItem(${item.timestamp})" 
                            class="ml-4 p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                            title="åˆ é™¤è®°å½•">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removeHistoryItem(timestamp) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç”¨é¤è®°å½•å—ï¼Ÿ')) {
                state.history = state.history.filter(item => item.timestamp !== timestamp);
                localStorage.setItem('dinner-history', JSON.stringify(state.history));
                renderHistory();
            }
        }
    </script>
</body>
</html>
